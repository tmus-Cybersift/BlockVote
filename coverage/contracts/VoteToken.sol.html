<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/VoteToken.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> VoteToken.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>10/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.5% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>3/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">40% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>4/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">47.62% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>10/21</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.6.0;
import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "./District.sol";
&nbsp;
contract VoteToken is ERC721, Ownable{
    mapping(uint256 =&gt; uint8) public district; //maps token ID to District voter it is issued to is on.
    mapping(uint256 =&gt; mapping(uint8=&gt;address)) public preferences; //maps token ID to the preferences selected by the voter.
    uint public voteStart; //Time (in seconds since epoch) 
    uint public voteEnd;
    
&nbsp;
    //Much of the ERC721 functionality will be restricted to only the District contracts.
    mapping(address =&gt; bool) public allowedContracts; 
<span class="fstat-no" title="function not covered" >    modifier OnlyAllowed {</span>
<span class="cstat-no" title="statement not covered" >        require(allowedContracts[msg.sender] == true || msg.sender == owner(),"Calling Address not in list of allowed contracts.")</span>;
        _;
    }
&nbsp;
    constructor(string memory __name, string memory __symbol, uint _voteStart, uint _voteEnd) ERC721(__name,__symbol) Ownable() public{
        voteStart = _voteStart;
        voteEnd = _voteEnd;
        allowedContracts[address(this)] = true;
    }
&nbsp;
    //Called For Each District Contract Address.
<span class="fstat-no" title="function not covered" >    function setAllowed(address _address) public onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        allowedContracts[_address] = true</span>;
    }
&nbsp;
    /*
    Ensures No tokens can be transferred (ie: voting) before or after voting period ends
    */
    function _beforeTokenTransfer(address from, address to, uint256 tokenId) internal override { 
        require( ( (now &gt;= voteStart &amp;&amp; now &lt;= voteEnd) || (_msgSender() == owner() &amp;&amp; now &lt;= voteEnd) ),"Voting Not Open."); 
    }
    
    /* Maps a given vote Token ID to a mapping of the voter's preferences (1..N) to the addresses of the corresponding candidates. */
    function setVotePreferences(uint256 _tokenId, address[] memory _preferences) public{
        _isApprovedOrOwner(_msgSender(), _tokenId);
&nbsp;
        for(uint8 i = 1; i &lt;= _preferences.length; i++){
            preferences[_tokenId][i] = _preferences[i-1];
        }
    }
    
    /* Utilises vanilla ERC721 mint functionality but adds the restrictions that the mint is rejected if the recipient has a balance larger than 0;
    As every voter may only be issued one vote and that only the owner of the VoteToken contract (the Election Controller contract) may call it.
    Additionally, it also assigns the number of the electoral district in which the voter resides as metadata*/
    function mint(address _to, uint256 _tokenId, uint8 _districtNo) public onlyOwner{
        <span class="missing-if-branch" title="else path not taken" >E</span>require(balanceOf(_to) == 0,"Recipient Already has a vote. (balance non 0)"); //no one may have more than 1 vote.
        _mint(_to , _tokenId);
        district[_tokenId] = _districtNo;
    }
    
    /*
    May be called only by District contracts (onlyAllowed). Used in order to redistribute votes from candidates that are eliminated in the process of counting.
    Has the additional restriction that each token must "belong" to the District that is attempting to seize it.
     */
<span class="fstat-no" title="function not covered" >    function transferAllBack(address _from) public OnlyAllowed {</span>
<span class="cstat-no" title="statement not covered" >        uint8 _districtNo = District(msg.sender).districtNumber();</span>
<span class="cstat-no" title="statement not covered" >        uint balance = balanceOf(_from);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        for(uint32 i = 0; i &lt; balance; i++){</span>
<span class="cstat-no" title="statement not covered" >            uint256 tokenId = tokenOfOwnerByIndex(_from,i);</span>
<span class="cstat-no" title="statement not covered" >            require(district[tokenId] == _districtNo,"Attempting to seize token from another district.")</span>;
<span class="cstat-no" title="statement not covered" >            transferFrom(_from,msg.sender,tokenId)</span>;
        }
    }
    
    /*Proxy for the vanilla transferFrom function of ERC721, but restricts it to only allowed callers (District contracts))*/
<span class="fstat-no" title="function not covered" >    function transferFrom(address from, address to, uint256 tokenId) public OnlyAllowed override {</span>
        
<span class="cstat-no" title="statement not covered" >        super.transferFrom(from,to,tokenId)</span>;
    }
&nbsp;
    /*
    Safe Transfer is used to check that a recipient of a token is either: a wallet address or, if it is a contract, that it has functionality that allows it to
    transfer otherwise make use of the tokens it receives. This was implemented in order to ensure tokens are not lost by being sent to a contract that has no way of moving them.
    It is not necessary for this application given the limited use-scope of our token. It has therefore been overriden with an empty function.
     */
<span class="fstat-no" title="function not covered" >    function safeTransferFrom(address from, address to, uint256 tokenId) public override {</span>
        /*unnecessary*/
    }
&nbsp;
    
<span class="fstat-no" title="function not covered" >    function kill() public onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        selfdestruct(msg.sender)</span>;
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Sep 13 2020 12:22:25 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
